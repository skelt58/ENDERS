<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.co.enders.ums.lgn.dao.LoginMapper">

	<select id="isValidUser" parameterType="loginVO" resultType="userVO">
		SELECT A.USER_ID
			 , A.DEPT_NO
			 , (SELECT DEPT_NM FROM NEO_DEPT WHERE DEPT_NO = A.DEPT_NO) DEPT_NM
			 , A.USER_NM
			 , A.TZ_CD
			 , A.UILANG
			 , A.STATUS
			 , B.TZ_TERM
			 , C.CD_NM CHARSET_NM
			 , (SELECT FONT FROM NEO_FONT WHERE CHARSET = A.CHARSET) FONT
		  FROM	NEO_USER A, NEO_TIMEZONE B, NEO_CD C
		 WHERE A.TZ_CD    = B.TZ_CD
		   AND A.USER_ID  = #{pUserId}
		   AND A.USER_PWD = #{pUserPwd}
		   AND A.CHARSET  = C.CD
		   AND C.CD_GRP   = 'C022'
		   AND A.UILANG   = C.UILANG
	</select>
	
	<select id="getUserProgList" parameterType="string" resultType="userProgVO">
		SELECT A.PROG_ID
			 , A.PROG_NM
			 , A.PROG_TARGET
			 , A.PROG_DOMAIN
			 , A.PROG_SCRIPT
		  FROM NEO_PROG A
			  ,	NEO_USER_PROG B
		 WHERE A.PROG_ID = B.PROG_ID
		   AND B.USER_ID = #{userId}
		   AND A.USE_YN = 'Y'
		UNION
		SELECT A.PROG_ID
			 , A.PROG_NM
			 , A.PROG_TARGET
			 , A.PROG_DOMAIN
			 , A.PROG_SCRIPT
		  FROM NEO_PROG A
			 , NEO_USER_AUTH_GRP B
			 , NEO_AUTH_GRP_PROG C
			 , NEO_AUTH_GRP D
		 WHERE A.PROG_ID = C.PROG_ID
		   AND B.AUTH_GRP_ID = C.AUTH_GRP_ID
		   AND B.AUTH_GRP_ID = D.AUTH_GRP_ID
		   AND A.USE_YN = 'Y'
		   AND D.USE_YN = 'Y'
		   AND B.USER_ID = #{userId}
		 ORDER BY PROG_NM ASC
	</select>
	
	<select id="getUserMenuList" parameterType="string" resultType="sysMenuVO">
		SELECT MENU_ID
			 , MENU_NM
			 , PARENTMENU_ID
			 , SOURCE_PATH
			 , SORT_SNO
			 , MENULVL_VAL
			 , SERVICE_GB
		  FROM NEO_SYSMENU
		 WHERE MENULVL_VAL = 1
		   AND MENU_ID IN (
							SELECT A.PARENTMENU_ID
							  FROM NEO_SYSMENU A, NEO_MENUUSERMAPP B
							 WHERE A.MENU_ID = B.MENU_ID
							   AND B.USER_ID = #{userId}
							   AND A.USE_YN = 'Y'
							)
		   AND USE_YN = 'Y'
        UNION ALL
		SELECT A.MENU_ID
			 , A.MENU_NM
			 , A.PARENTMENU_ID
			 , A.SOURCE_PATH
			 , A.SERVICE_GB
			 , A.MENULVL_VAL
			 , A.SERVICE_GB
		  FROM NEO_SYSMENU A, NEO_MENUUSERMAPP B
		 WHERE A.MENU_ID = B.MENU_ID
		   AND A.MENULVL_VAL = 2
		   AND B.USER_ID = #{userId}
		   AND A.USE_YN = 'Y'
         ORDER BY PARENTMENU_ID, SORT_SNO
	</select>
	
	<select id="getUserMenuLvl1List" parameterType="string" resultType="sysMenuVO">
		SELECT MENU_ID
			 , MENU_NM
			 , NVL(PARENTMENU_ID, 'M0000000') PARENTMENU_ID
			 , SOURCE_PATH
			 , SORT_SNO
			 , MENULVL_VAL
		  FROM NEO_SYSMENU
		 WHERE MENULVL_VAL = 1
		   AND MENU_ID IN (
							SELECT A.PARENTMENU_ID
							  FROM NEO_SYSMENU A, NEO_MENUUSERMAPP B
							 WHERE A.MENU_ID = B.MENU_ID
							   AND B.USER_ID = #{userId}
							   AND A.USE_YN = 'Y'
							)
		   AND USE_YN = 'Y'
	</select>
	
	<select id="getUserMenuLvl2List" parameterType="string" resultType="sysMenuVO">
		SELECT A.MENU_ID
			 , A.MENU_NM
			 , A.PARENTMENU_ID
			 , A.SOURCE_PATH
			 , A.SERVICE_GB
			 , MENULVL_VAL
		  FROM NEO_SYSMENU A, NEO_MENUUSERMAPP B
		 WHERE A.MENU_ID = B.MENU_ID
		   AND A.MENULVL_VAL = 2
		   AND B.USER_ID = #{userId}
		   AND A.USE_YN = 'Y'
	</select>
	
	<insert id="insertLoginHist" parameterType="lgnHistVO">
		INSERT INTO NEO_LGN_HST
		(
			LGN_HST_ID
			, DEPT_NO
			, USER_ID
			, LGN_DT
			, LGN_IP
		)
		VALUES
		(
			NEO_LGN_HST_SEQ.NEXTVAL
			, #{deptNo}
			, #{userId}
			, #{lgnDt}
			, #{lgnIp}
		)
	</insert>

</mapper>